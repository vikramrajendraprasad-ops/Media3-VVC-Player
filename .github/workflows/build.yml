name: Build Media3 VVC & APV Player
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        repository: androidx/media
        path: media
        ref: main

    - name: Install 2026 Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm yasm make autoconf automake libtool pkg-config git

    - uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: temurin

    - name: Setup NDK r26b
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b

    - name: Prepare FFmpeg Source
      run: |
        # Use a specific 2026-capable commit of FFmpeg
        git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg_source
        ln -s "$(pwd)/ffmpeg_source" "$(pwd)/media/libraries/decoder_ffmpeg/src/main/jni/ffmpeg"

    - name: Build FFmpeg Native Libs
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        chmod +x build_ffmpeg.sh
        
        # 1. Force ONLY arm64-v8a to stop the 'armv7' compiler error
        sed -i 's/ENABLED_ABIS=(.*/ENABLED_ABIS=(arm64-v8a)/g' build_ffmpeg.sh
        
        # 2. RUN SCRIPT WITH CORRECT ORDER
        # Arg 1: JNI path, Arg 2: NDK path, Arg 3: Host, Arg 4+: Decoders
        ./build_ffmpeg.sh \
          "$(pwd)/.." \
          "${{ steps.setup-ndk.outputs.ndk-path }}" \
          "linux-x86_64" \
          vvc apv h264 hevc av1 dav1d

    - name: Patch Media3 for Video Decoders
      run: |
        cd media
        # Define the path to the Library file
        LIB_FILE="libraries/decoder_ffmpeg/src/main/java/androidx/media3/decoder/ffmpeg/FfmpegLibrary.java"
        
        # Add VVC/APV to the recognized list
        sed -i '/"video\/hevc"/a \    "video\/vvc",\n    "video\/apv",' $LIB_FILE
        
        # Enable Extension rendering in Demo App
        DEMO_UTIL="demos/main/src/main/java/androidx/media3/demo/main/DemoUtil.java"
        sed -i 's/EXTENSION_RENDERER_MODE_OFF/EXTENSION_RENDERER_MODE_PREFER/g' $DEMO_UTIL

    - name: Compile APK
      run: |
        cd media
        # We need to skip lint and some checks because we've modified the source
        chmod +x gradlew
        ./gradlew :demo-main:assembleRelease --stacktrace

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: Media3-VVC-APV-Player
        path: media/demos/main/build/outputs/apk/release/*.apk
