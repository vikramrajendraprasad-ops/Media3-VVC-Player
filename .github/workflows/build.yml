name: Build Media3 VVC Player
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Media3 Source
        uses: actions/checkout@v4
        with:
          repository: androidx/media
          ref: release

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Prepare FFmpeg Source
        run: |
          cd libraries/decoder_ffmpeg/src/main/jni
          git clone --depth 1 -b release/6.1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

      - name: Build FFmpeg for VVC & APV
        run: |
          cd libraries/decoder_ffmpeg/src/main/jni
          # Enable the 2026 codecs in the build script
          sed -i 's/--enable-decoder=h264/--enable-decoder=vvc,apv,h264,hevc,av1/g' build_ffmpeg.sh
          ./build_ffmpeg.sh "$(pwd)" "$ANDROID_NDK_HOME" "arm64-v8a"

      - name: Patch Player for Software Priority
        run: |
          # 1. Add VVC/APV to the Java Mime-Type list
          FILE="libraries/decoder_ffmpeg/src/main/java/androidx/media3/decoder/ffmpeg/FfmpegLibrary.java"
          sed -i '/"video\/hevc"/a \    "video\/vvc",\n    "video\/apv",' $FILE
          
          # 2. Force Demo App to use FFmpeg extension first
          DEMO_UTIL="demos/main/src/main/java/androidx/media3/demo/main/DemoUtil.java"
          sed -i 's/EXTENSION_RENDERER_MODE_OFF/EXTENSION_RENDERER_MODE_PREFER/g' $DEMO_UTIL
          
          # 3. Force TextureView for software rendering support
          LAYOUT="demos/main/src/main/res/layout/player_activity.xml"
          sed -i 's/surface_type="surface_view"/surface_type="texture_view"/g' $LAYOUT

      - name: Compile APK
        run: ./gradlew :demo-main:assembleRelease

      - name: Upload Finished Player
        uses: actions/upload-artifact@v4
        with:
          name: Media3-VVC-Player
          path: demos/main/build/outputs/apk/release/*.apk
