name: Build Media3 VVC APV IAMF Player

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1Ô∏è‚É£ Checkout Media3
    # --------------------------------------------------
    - name: Checkout Media3
      uses: actions/checkout@v4
      with:
        repository: androidx/media
        path: media
        ref: main

    # --------------------------------------------------
    # 2Ô∏è‚É£ Install system dependencies
    # --------------------------------------------------
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm yasm make python3

    # --------------------------------------------------
    # 3Ô∏è‚É£ Java + Android NDK
    # --------------------------------------------------
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - name: Setup Android NDK r26b
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b

    # --------------------------------------------------
    # 4Ô∏è‚É£ Clone FFmpeg
    # --------------------------------------------------
    - name: Clone FFmpeg
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

    # --------------------------------------------------
    # 5Ô∏è‚É£ Build FFmpeg (VVC + APV + IAMF)
    # --------------------------------------------------
    - name: Build FFmpeg extensions
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        chmod +x build_ffmpeg.sh

        sed -i 's/ENABLED_ABIS=(.*/ENABLED_ABIS=(arm64-v8a)/g' build_ffmpeg.sh
        sed -i 's/--disable-postproc//g' build_ffmpeg.sh

        ./build_ffmpeg.sh "$(pwd)/.." "$ANDROID_NDK_HOME" \
          linux-x86_64 24 \
          vvc apv iamf opus hevc h264

    # --------------------------------------------------
    # 6Ô∏è‚É£ Patch Media3 MP4 parser (SAFE & OPTIONAL)
    # --------------------------------------------------
    - name: Patch Media3 MP4 parser for VVC / APV / IAMF
      run: |
        set +e

        ATOM=$(find media -path "*mp4*" -name "Atom.java" | head -n 1)
        PARSER=$(find media -path "*mp4*" -name "AtomParsers.java" | head -n 1)

        echo "Atom.java: $ATOM"
        echo "AtomParsers.java: $PARSER"

        if [ -n "$ATOM" ] && [ -n "$PARSER" ]; then
          echo "üîß Patching MP4 parser (experimental)"

          grep -q TYPE_vvc1 "$ATOM" || sed -i '/TYPE_hvc1/a \
            public static final int TYPE_vvc1 = Util.getIntegerCodeForString("vvc1");\n\
            public static final int TYPE_vvi1 = Util.getIntegerCodeForString("vvi1");\n\
            public static final int TYPE_apv1 = Util.getIntegerCodeForString("apv1");\n\
            public static final int TYPE_iamf = Util.getIntegerCodeForString("iamf");' "$ATOM"

          grep -q 'video/vvc' "$PARSER" || sed -i '/switch *(atomType)/a \
            case Atom.TYPE_vvc1:\n\
            case Atom.TYPE_vvi1:\n\
              return "video/vvc";\n\
            case Atom.TYPE_apv1:\n\
              return "video/apv";\n\
            case Atom.TYPE_iamf:\n\
              return "audio/iamf";' "$PARSER"
        else
          echo "‚ö†Ô∏è MP4 parser not found ‚Äî skipping (MKV-only support)"
        fi

    # --------------------------------------------------
    # 7Ô∏è‚É£ Force FFmpeg renderer only
    # --------------------------------------------------
    - name: Force FFmpeg decoder only
      run: |
        UTIL=$(find media -name "DemoUtil.java" | head -n 1)

        sed -i 's/new DefaultRenderersFactory(context)/new DefaultRenderersFactory(context)\
          .setEnableDecoderFallback(false)\
          .setExtensionRendererMode(DefaultRenderersFactory.EXTENSION_RENDERER_MODE_PREFER)/' "$UTIL"

    # --------------------------------------------------
    # 8Ô∏è‚É£ Register experimental codecs
    # --------------------------------------------------
    - name: Register experimental codecs
      run: |
        LIB=$(find media -name "FfmpegLibrary.java" | head -n 1)

        sed -i '/video\/hevc/a \
          "video\/vvc",\n\
          "video\/apv",\n\
          "audio\/iamf",' "$LIB"

    # --------------------------------------------------
    # 9Ô∏è‚É£ Build APK (AUTO-DETECT MODULE)
    # --------------------------------------------------
    - name: Build Media3 demo APK
      run: |
        cd media
        chmod +x gradlew

        if ./gradlew projects | grep -q ":demos:main"; then
          echo "‚úÖ Using :demos:main"
          ./gradlew :demos:main:assembleDebug
          APK_DIR="demos/main/build/outputs/apk/debug"
        else
          echo "‚úÖ Using :demo"
          ./gradlew :demo:assembleDebug
          APK_DIR="demo/build/outputs/apk/debug"
        fi

        echo "=== APK files ==="
        ls "$APK_DIR" || true

        mkdir -p ../output
        cp "$APK_DIR"/*.apk ../output/Media3_VVC_APV_IAMF.apk

    # --------------------------------------------------
    # üîü Upload APK artifact
    # --------------------------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Media3-VVC-APV-IAMF-Experimental
        path: output/Media3_VVC_APV_IAMF.apk
