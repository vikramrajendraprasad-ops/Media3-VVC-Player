name: Build Media3 Pro Player (VVC + APV + IAMF)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Media3 (STABLE)
        uses: actions/checkout@v4
        with:
          repository: androidx/media
          path: media
          ref: 1.3.1
          fetch-depth: 0

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm make python3

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android NDK r26b
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Clone FFmpeg
        run: |
          cd media/libraries/decoder_ffmpeg/src/main/jni
          git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

      - name: Build FFmpeg (VVC / APV / IAMF)
        run: |
          cd media/libraries/decoder_ffmpeg/src/main/jni
          chmod +x build_ffmpeg.sh
          sed -i 's/ENABLED_ABIS=(.*/ENABLED_ABIS=(arm64-v8a)/g' build_ffmpeg.sh
          sed -i 's/--disable-postproc//g' build_ffmpeg.sh

          ./build_ffmpeg.sh "$(pwd)/.." "$ANDROID_NDK_HOME" \
            linux-x86_64 24 vvc apv iamf opus h264 hevc

      - name: Register Codecs and Force FFmpeg
        run: |
          LIB=$(find media -name "FfmpegLibrary.java" | head -n 1)
          sed -i '/"video\/hevc"/a \
            "video\/vvc",\n\
            "video\/apv",\n\
            "audio\/iamf",' "$LIB"

          UTIL=$(find media -name "DemoUtil.java" | head -n 1)
          sed -i 's/new DefaultRenderersFactory(context)/new DefaultRenderersFactory(context)\
            .setEnableDecoderFallback(false)\
            .setExtensionRendererMode(DefaultRenderersFactory.EXTENSION_RENDERER_MODE_PREFER)/' "$UTIL"

      - name: Allow APV / VVC / IAMF in Extractors
        run: |
          set +e

          ATOM=$(find media -name "Atom.java" | head -n 1)
          PARSER=$(find media -name "AtomParsers.java" | head -n 1)

          if [ -n "$ATOM" ] && [ -n "$PARSER" ]; then
            grep -q TYPE_vvc1 "$ATOM" || sed -i '/TYPE_hvc1/a \
              public static final int TYPE_vvc1 = Util.getIntegerCodeForString("vvc1");\n\
              public static final int TYPE_vvi1 = Util.getIntegerCodeForString("vvi1");\n\
              public static final int TYPE_apv1 = Util.getIntegerCodeForString("apv1");\n\
              public static final int TYPE_iamf = Util.getIntegerCodeForString("iamf");' "$ATOM"

            grep -q video/vvc "$PARSER" || sed -i '/switch *(atomType)/a \
              case Atom.TYPE_vvc1:\n\
              case Atom.TYPE_vvi1:\n\
                return "video/vvc";\n\
              case Atom.TYPE_apv1:\n\
                return "video/apv";\n\
              case Atom.TYPE_iamf:\n\
                return "audio/iamf";' "$PARSER"
          fi

      - name: Build APK
        run: |
          cd media
          chmod +x gradlew
          ./gradlew :demo:assembleDebug
          mkdir -p ../output_apk
          cp demo/build/outputs/apk/debug/*.apk ../output_apk/Media3_VVC_APV_IAMF.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Media3-VVC-APV-IAMF
          path: output_apk/Media3_VVC_APV_IAMF.apk
