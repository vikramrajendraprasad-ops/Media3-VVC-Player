name: Media3 FFmpeg VVC IAMF Player (STABLE)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1️⃣ Checkout Media3 (REAL TAG, FULL HISTORY)
    # --------------------------------------------------
    - name: Checkout Media3 (stable tag)
      uses: actions/checkout@v4
      with:
        repository: androidx/media
        path: media
        ref: 1.3.1          # ✅ REAL Media3 tag
        fetch-depth: 0      # ✅ REQUIRED for tags

    # --------------------------------------------------
    # 2️⃣ System deps
    # --------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm yasm make

    # --------------------------------------------------
    # 3️⃣ Java + NDK
    # --------------------------------------------------
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b

    # --------------------------------------------------
    # 4️⃣ FFmpeg
    # --------------------------------------------------
    - name: Clone FFmpeg
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

    # --------------------------------------------------
    # 5️⃣ Build FFmpeg (VVC + IAMF)
    # --------------------------------------------------
    - name: Build FFmpeg
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        chmod +x build_ffmpeg.sh
        sed -i 's/ENABLED_ABIS=(.*/ENABLED_ABIS=(arm64-v8a)/g' build_ffmpeg.sh

        ./build_ffmpeg.sh "$(pwd)/.." "$ANDROID_NDK_HOME" \
          linux-x86_64 24 \
          vvc iamf opus hevc h264

    # --------------------------------------------------
    # 6️⃣ Force FFmpeg renderer
    # --------------------------------------------------
    - name: Force FFmpeg decoder
      run: |
        UTIL=$(find media -name "DemoUtil.java" | head -n 1)
        sed -i 's/EXTENSION_RENDERER_MODE_OFF/EXTENSION_RENDERER_MODE_PREFER/g' "$UTIL"

    # --------------------------------------------------
    # 7️⃣ Build APK (KNOWN MODULE)
    # --------------------------------------------------
    - name: Build demo APK
      run: |
        cd media
        chmod +x gradlew
        ./gradlew :demo:assembleDebug

        mkdir -p ../output
        cp demo/build/outputs/apk/debug/*.apk \
           ../output/Media3_FFmpeg_VVC_IAMF.apk

    # --------------------------------------------------
    # 8️⃣ Upload APK
    # --------------------------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Media3-FFmpeg-VVC-IAMF
        path: output/Media3_FFmpeg_VVC_IAMF.apk
