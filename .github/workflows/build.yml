name: Build Media3 VVC APV IAMF Player

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1Ô∏è‚É£ Checkout Media3
    # --------------------------------------------------
    - name: Checkout Media3
      uses: actions/checkout@v4
      with:
        repository: androidx/media
        path: media
        ref: main

    # --------------------------------------------------
    # 2Ô∏è‚É£ Install build tools
    # --------------------------------------------------
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          nasm yasm make python3

    # --------------------------------------------------
    # 3Ô∏è‚É£ Java + Android NDK
    # --------------------------------------------------
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - name: Setup Android NDK r26b
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b

    # --------------------------------------------------
    # 4Ô∏è‚É£ Prepare FFmpeg source
    # --------------------------------------------------
    - name: Clone FFmpeg
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

    # --------------------------------------------------
    # 5Ô∏è‚É£ Build FFmpeg (VVC + APV + IAMF)
    # --------------------------------------------------
    - name: Build FFmpeg extensions
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        chmod +x build_ffmpeg.sh

        # arm64 only
        sed -i 's/ENABLED_ABIS=(.*/ENABLED_ABIS=(arm64-v8a)/g' build_ffmpeg.sh
        sed -i 's/--disable-postproc//g' build_ffmpeg.sh

        ./build_ffmpeg.sh "$(pwd)/.." "$ANDROID_NDK_HOME" \
          linux-x86_64 24 \
          vvc apv iamf opus hevc h264

    # --------------------------------------------------
    # 6Ô∏è‚É£ üî• PATCH Media3 MP4 EXTRACTOR (CRITICAL)
    # --------------------------------------------------
    - name: Patch Media3 extractor for VVC / APV / IAMF
      run: |
        set -e

        ATOM=$(find media -name "Atom.java" | grep mp4 | head -n 1)
