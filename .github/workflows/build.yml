name: Build Media3 Pro Player (VVC+APV+IAMF)
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Media3
        uses: actions/checkout@v4
        with:
          repository: androidx/media
          path: media
          ref: main

      - name: Install Build Tools
        run: sudo apt-get update && sudo apt-get install -y nasm yasm make git python3

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup NDK r26b
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Build Native FFmpeg Core
        run: |
          cd media/libraries/decoder_ffmpeg/src/main/jni
          git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg
          chmod +x build_ffmpeg.sh
          
          # 1. Fix: Force arm64 only (prevents building for x86/32-bit which wastes time)
          sed -i 's/ENABLED_ABIS=(.*/ENABLED_ABIS=(arm64-v8a)/g' build_ffmpeg.sh
          
          # 2. Fix: Remove "--disable-postproc" flag which causes the "Unknown option" error in new FFmpeg
          sed -i 's/--disable-postproc//g' build_ffmpeg.sh

          # 3. Build: Removed "24" to prevent argument misalignment. 
          # The script will default to API 21, which is compatible with all modern Android versions.
          ./build_ffmpeg.sh "$(pwd)/.." "${{ steps.setup-ndk.outputs.ndk-path }}" "linux-x86_64" vvc apv iamf opus h264 hevc

      - name: ðŸ›¡ï¸ Professional Surgery (VVC/APV/IAMF)
        shell: python
        run: |
          import os

          def patch_file(file_path, search_text, replace_text):
              if os.path.exists(file_path):
                  with open(file_path, 'r') as f:
                      content = f.read()
                  if search_text in content:
                      new_content = content.replace(search_text, replace_text)
                      with open(file_path, 'w') as f:
                          f.write(new_content)
                      print(f"Successfully patched: {file_path}")
                  else:
                      print(f"Warning: Search text '{search_text}' not found in {file_path}")

          # 1. Register New MIME Types in FFmpeg Extension
          lib_files = os.popen('find media -name "FfmpegLibrary.java"').read().splitlines()
          if lib_files:
              patch_file(lib_files[0], '"video/hevc"', '"video/hevc", "video/vvc", "video/apv", "audio/iamf"')

          # 2. Enable Extension Priority in Demo Util
          util_files = os.popen('find media -name "DemoUtil.java"').read().splitlines()
          if util_files:
              patch_file(util_files[0], "EXTENSION_RENDERER_MODE_OFF", "EXTENSION_RENDERER_MODE_PREFER")

          # 3. Inject Button and Local File Logic into SampleChooserActivity
          activity_files = os.popen('find media/demo -name "SampleChooserActivity.java"').read().splitlines()
          if activity_files:
              activity_file = activity_files[0]
              with open(activity_file, 'r') as f:
                  content = f.read()
              
              # Button Logic
              btn_logic = 'android.widget.Button b = new android.widget.Button(this); b.setText("ðŸ“‚ OPEN VVC/APV/IAMF"); b.setBackgroundColor(0xFF6200EE); b.setTextColor(0xFFFFFFFF); b.setOnClickListener(v -> { android.content.Intent i = new android.content.Intent(android.content.Intent.ACTION_OPEN_DOCUMENT); i.setType("*/*"); startActivityForResult(i, 1001); }); addContentView(b, new android.view.ViewGroup.LayoutParams(-1, 200));'
              
              if 'setContentView(view);' in content:
                  content = content.replace('setContentView(view);', f'setContentView(view); {btn_logic}')
                  
                  # Intent Bridge Logic
                  intent_bridge = """
                  @Override
                  public void onActivityResult(int req, int res, android.content.Intent data) {
                      super.onActivityResult(req, res, data);
                      if (req == 1001 && res == -1 && data != null && data.getData() != null) {
                          android.content.Intent pI = new android.content.Intent("androidx.media3.demo.main.action.VIEW");
                          pI.setClass(this, androidx.media3.demo.main.PlayerActivity.class);
                          pI.setDataAndType(data.getData(), "*/*");
                          pI.addFlags(android.content.Intent.FLAG_GRANT_READ_URI_PERMISSION);
                          pI.putExtra("prefer_extension_decoders", true);
                          pI.putExtra("title", "Custom VVC/APV Stream");
                          startActivity(pI);
                      }
                  }
                  """
                  last_brace_index = content.rfind('}')
                  if last_brace_index != -1:
                      content = content[:last_brace_index] + intent_bridge + "}"
                      with open(activity_file, 'w') as f:
                          f.write(content)
                      print("Successfully injected Java logic.")
              else:
                  print("Error: Could not find setContentView hook.")

      - name: Final Compilation
        run: |
          cd media
          chmod +x gradlew
          ./gradlew :demo:assembleDebug

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Media3-VVC-Pro-Player
          path: media/demo/build/outputs/apk/debug/*.apk
