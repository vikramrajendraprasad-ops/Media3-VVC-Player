name: Build Media3 VVC & APV Player
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        repository: androidx/media
        path: media
        ref: main
    - name: Install Dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y nasm make autoconf automake libtool pkg-config git
    - uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: temurin
    - name: Setup NDK r25c  # FIXED: Use r25c (stable for Media3)
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
    - name: Prepare FFmpeg
      run: |
        git clone --depth 1 --branch master https://github.com/FFmpeg/FFmpeg.git ffmpeg_source
        ln -s "$(pwd)/ffmpeg_source" "$(pwd)/media/libraries/decoder_ffmpeg/src/main/jni/ffmpeg"
    - name: Build FFmpeg  # FIXED: Proper env vars
      env:
        FFMPEG_MODULE_PATH: ${{ github.workspace }}/media/libraries/decoder_ffmpeg/src/main
      run: |
        cd media/libraries/decoder_ffmpeg/src/main/jni
        chmod +x build_ffmpeg.sh
        sed -i 's/ENABLED_ABIS=(.*/ENABLED_ABIS=(arm64-v8a)/g' build_ffmpeg.sh
        export NDK_PATH="${{ steps.setup-ndk.outputs.ndk-path }}"
        export ANDROID_ABI="arm64-v8a"
        export HOST_PLATFORM="linux-x86_64"
        ./build_ffmpeg.sh h264 hevc av1 vvc apv  # Decoders LAST
    - name: Patch Code
      run: |
        cd media
        sed -i '/video/hevc"/a    "video/vvc",' libraries/decoder_ffmpeg/src/main/java/androidx/media3/decoder/ffmpeg/FfmpegLibrary.java
        sed -i '/video/vvc"/a    "video/apv",' libraries/decoder_ffmpeg/src/main/java/androidx/media3/decoder/ffmpeg/FfmpegLibrary.java
        sed -i 's/EXTENSION_RENDERER_MODE_OFF/EXTENSION_RENDERER_MODE_PREFER/' demos/main/src/main/java/androidx/media3/demo/main/DemoUtil.java
    - name: Build APK
      run: |
        cd media
        chmod +x gradlew
        ./gradlew :demos:main:assembleRelease
    - uses: actions/upload-artifact@v4
      with:
        name: Media3-VVC-APV-APK
        path: media/demos/main/build/outputs/apk/release/
