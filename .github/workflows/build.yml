name: Build Media3 VVC Player
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Media3 Source
        uses: actions/checkout@v4
        with:
          # THIS IS THE KEY: We clone the official Media3 repo
          repository: androidx/media
          ref: release 

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Prepare FFmpeg Source
        run: |
          cd libraries/decoder_ffmpeg/src/main/jni
          # Clone the 2026-ready FFmpeg master branch for VVC/APV
          git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

      - name: Build FFmpeg for VVC & APV
        run: |
          cd libraries/decoder_ffmpeg/src/main/jni
          
          # Give the build script execution permissions
          chmod +x build_ffmpeg.sh
          
          # Enable VVC and APV in the build configuration
          sed -i 's/--enable-decoder=h264/--enable-decoder=vvc,apv,h264,hevc,av1/g' build_ffmpeg.sh
          
          # Arguments: 1:JNI_PATH, 2:NDK_PATH, 3:HOST, 4:TARGET_ARCH
          ./build_ffmpeg.sh \
            "$(pwd)" \
            "${{ steps.setup-ndk.outputs.ndk-path }}" \
            "linux-x86_64" \
            "arm64-v8a"

      - name: Patch Player for Software VVC
        run: |
          # Add VVC to the Java bridge so it recognizes the format
          FILE="libraries/decoder_ffmpeg/src/main/java/androidx/media3/decoder/ffmpeg/FfmpegLibrary.java"
          sed -i '/"video\/hevc"/a \    "video\/vvc",\n    "video\/apv",' $FILE
          
          # Set the Demo App to prioritize extensions (Software)
          DEMO_UTIL="demos/main/src/main/java/androidx/media3/demo/main/DemoUtil.java"
          sed -i 's/EXTENSION_RENDERER_MODE_OFF/EXTENSION_RENDERER_MODE_PREFER/g' $DEMO_UTIL
          
          # Force TextureView (Required for CPU-based VVC rendering)
          LAYOUT="demos/main/src/main/res/layout/player_activity.xml"
          sed -i 's/surface_type="surface_view"/surface_type="texture_view"/g' $LAYOUT

      - name: Compile Demo APK
        run: |
          chmod +x gradlew
          ./gradlew :demo-main:assembleRelease

      - name: Upload Finished Player
        uses: actions/upload-artifact@v4
        with:
          name: Media3-VVC-Player
          path: demos/main/build/outputs/apk/release/*.apk
          
