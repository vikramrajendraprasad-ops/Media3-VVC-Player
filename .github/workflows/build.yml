name: Build Media3 VVC Player
on:
  workflow_dispatch: # Allows you to start the build manually

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Media3 Source
        uses: actions/checkout@v4
        with:
          repository: androidx/media
          ref: release # Use the latest stable release branch

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK
        uses: nndk/setup-ndk@v1
        with:
          ndk-version: r26b # Your preferred version

      - name: Prepare FFmpeg 2026 Source
        run: |
          cd libraries/decoder_ffmpeg/src/main/jni
          git clone --depth 1 https://git.ffmpeg.org/ffmpeg.git ffmpeg

      - name: Build FFmpeg for VVC & APV
        run: |
          cd libraries/decoder_ffmpeg/src/main/jni
          # We edit the build script to force VVC and APV support
          sed -i 's/--enable-decoder=h264/--enable-decoder=vvc,apv,h264,hevc,av1/g' build_ffmpeg.sh
          ./build_ffmpeg.sh "$(pwd)" "$ANDROID_NDK_HOME" "arm64-v8a"

      - name: Patch Player for Software Priority
        run: |
          # 1. Inject VVC/APV into the Extension's recognized list
          FILE="libraries/decoder_ffmpeg/src/main/java/androidx/media3/decoder/ffmpeg/FfmpegLibrary.java"
          sed -i '/"video\/hevc"/a \    "video\/vvc",\n    "video\/apv",' $FILE
          
          # 2. Force Demo App to prefer Software Extensions
          DEMO_UTIL="demos/main/src/main/java/androidx/media3/demo/main/DemoUtil.java"
          sed -i 's/EXTENSION_RENDERER_MODE_OFF/EXTENSION_RENDERER_MODE_PREFER/g' $DEMO_UTIL
          
          # 3. Force TextureView (Required for Software rendering)
          LAYOUT="demos/main/src/main/res/layout/player_activity.xml"
          sed -i 's/surface_type="surface_view"/surface_type="texture_view"/g' $LAYOUT

      - name: Compile APK
        run: ./gradlew :demo-main:assembleRelease

      - name: Upload Finished Player
        uses: actions/upload-artifact@v4
        with:
          name: Media3-VVC-Player
          path: demos/main/build/outputs/apk/release/*.apk
